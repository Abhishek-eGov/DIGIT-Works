openapi: 3.0.0
info:
  version: 1.0.0
  title: Muster Roll Service
  description: ''

paths:
  /muster-roll/v1/_estimate:
    post:
      tags:
        - Muster Roll
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MusterRollRequest'
      responses:
        '202':
          description: 'Muster Roll created'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MusterRollResponse'

  /muster-roll/v1/_create:
    post:
      tags:
        - Muster Roll
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MusterRollRequest'
      responses:
        '202':
          description: 'Muster Roll created'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MusterRollResponse'

  /muster-roll/v1/_update:
    post:
      tags:
        - Muster Roll
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MusterRollRequest'
      responses:
        '202':
          description: 'Muster Roll updated'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MusterRollResponse'

  /muster-roll/v1/_search:
    post:
      tags:
        - Muster Roll
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestInfoWrapper'
      parameters:
        - $ref: 'https://raw.githubusercontent.com/egovernments/DIGIT-OSS/master/core-services/docs/common-contract.yml#/components/parameters/tenantId'
        - name: ids
          description: Ids of the muster roll
          in: query
          schema:
            type: array
            items:
              type: string
        - name: musterRollNumber
          description: (Custom-formatted) Muster roll number
          in: query
          schema:
            type: string
        - name: registerId
          description: Register Id
          in: query
          schema:
            type: string
        - name: fromDate
          description: Return registers with any overlap in the given time period
          in: query
          schema:
            type: number
        - name: toDate
          description: Return registers with any overlap in the given time period
          in: query
          schema:
            type: number
        - name: status
          description: Status of the muster roll. This can't be the only query param. It should be paired with some other search param.
          in: query
          schema:
            type: string
        - name: musterRollStatus
          description: Workflow Status of the muster roll. This can't be the only query param. It should be paired with some other search param.
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 'Search results'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MusterRollResponse'

components:
  schemas:
    MusterRoll:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifer of the roll
          readOnly: true
        tenantId:
          type: string
          example: pb.amritsar
        musterRollNumber:
          type: string
          description: Custom-formatted system generated unique identifier
          readOnly: true
        registerId:
          type: string
          description: Reference to the register id upon which the muster roll is being generated.
        status:
          type: string
          enum:
            - ACTIVE
            - INACTIVE
            - CANCELLED
        musterRollStatus:
          type: string
          description: It will store the state of the workflow.
          example: CREATED
        startDate:
          type: number
          format: timestamp
          example: 1665497225000
          description: Timestamp of the start date in milliseconds. In case of weekly registers, there will be additional checks for the starting date like muster roll start on every Monday.
        endDate:
          type: number
          format: timestamp
          example: 1665497271000
          description: Timestamp of the end date in milliseconds. In case of mandatory weekly muster rolls, it is set automatically.
        individualEntries:
          type: array
          items:
            $ref: '#/components/schemas/IndividualEntry'
        additionalDetails:
          type: object
          description: This is an updatable field from the user's input.
      required:
        - tenantId
        - registerId
        - startDate

    IndividualEntry:
      type: object
      readOnly: true
      properties:
        Id:
          type: string
          description: Id of the IndividualEntry
        individualId:
          type: string
          description: Reference of the attendee from the Individual Registry.
        actualTotalAttendance:
          type: number
          readOnly: true
          description: It is the computed sum of attendance in the given time period of the muster roll. This will be stored in the muster roll service's db. It will be computed only when the muster is created. So the computation will happen with CREATE actions only.
        modifiedTotalAttendance:
          type: number
          readOnly: true
          description: It is the modified sum of attendance in the given time period of the muster roll. This will be stored in the muster roll service's db. It will be stored when the totalAttendance is edited. So the updation will happen with EDIT actions only.
        attendanceEntries:
          type: array
          readOnly: true
          items:
            $ref: '#/components/schemas/AttendanceEntry'
        additionalDetails:
          type: object
          description: This can be used to store skillset that is a requirement for Mukta. This is an updatable field from the user's input.

    AttendanceEntry:
      type: object
      readOnly: true
      description: This computed data will also be stored as part of the muster roll db.
      properties:
        Id:
          type: string
          description: Id of the AttendanceEntry
        time:
          type: number
          readOnly: true
          format: timestamp
          description: The timestamp for a given time period against which the attendance is marked.
        attendance:
          type: number
          example: 0
          description: It is the computed attendance value based on the entry and exit events fetched from the Attendance service. The muster roll service will still allow the user to override the value of this attendance.
        additionalDetails:
          type: object
          description: This is an updatable field from the user's input.

    AttendanceLog:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: System generated unique identifier for the entry
          readOnly: true
        registerId:
          type: string
          description: Unique identifier of the register
        individualId:
          type: string
          format: uuid
          description: The individual for which the attendance is being marked
        tenantId:
          type: string
          example: pb.amritsar
          description: Tenant Id of the register
        time:
          type: number
          format: timestamp
          description: The timestamp at which the event has been recorded.
        type:
          type: string
          description: Configurable in MDMS. [ENTRY/EXIT/...]
        status:
          type: string
          enum:
            - ACTIVE
            - INACTIVE
          description: The attendance log of the cancelled event can be marked as inactive.
        documentIds:
          description: Used to store file store ids. Need to verify validity of them using file store service.
          type: array
          items:
            $ref: 'https://raw.githubusercontent.com/egovernments/DIGIT-OSS/master/core-services/docs/common-contract.yml#/components/schemas/Document'
        additionalDetails:
          type: object
      required:
        - registerId
        - individualId
        - tenantId
        - time
        - type
    AttendanceLogResponse:
      type: object
      properties:
        responseInfo:
          $ref: 'https://raw.githubusercontent.com/egovernments/DIGIT-OSS/subhashini_devguide_changes/core-services/docs/common-contract.yml#/definitions/ResponseInfo'
        attendance:
          type: array
          items:
            $ref: '#/components/schemas/AttendanceLog'

    StaffPermission:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: System generated unique identifier for the granted permission request
          readOnly: true
        registerId:
          type: string
          description: Identifier of the register. This field will not be shown when this object is part of the register object. It is present so that we can reuse this object for access permission requests.
        userId:
          type: string
          description: Identifier of the user of the system
        tenantId:
          type: string
          format: string
          example: pb.amritsar
          description: Tenant Id to which the staff belongs
        enrollmentDate:
          readOnly: true
          type: number
          description: The timestamp at which the permission is granted. It is set to the current time when the create api is called.
        denrollmentDate:
          readOnly: true
          type: number
          description: The timestamp at which the access permission is revoked. It is set to the current time when the delete api is called.
      required:
        - registerId
        - userId

    AttendanceRegister:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 64e33343-7b4c-4353-9abf-4de8f5bcd732
          description: System generated unique identifier of the register
          readOnly: true
        tenantId:
          type: string
          example: pb.amritsar
          description: Tenant Id of the register
        registerNumber:
          type: string
          example: REG/2022-23/001
          description: System generated id with custom formatting
          readOnly: true
        name:
          type: string
          example: Class-10-E Physics
          description: Name of the register
          maxLength: 140
        startDate:
          type: number
          format: timestamp
          example: 1665497225000
          description: Timestamp of the start date in milliseconds
        endDate:
          type: number
          format: timestamp
          example: 1665497271000
          description: Timestamp of the end date in milliseconds. After the end date no modifications will be allowed to the register.
        status:
          type: string
          enum:
            - ACTIVE
            - INACTIVE
          description: Stores if the register is active or not. Inactive registers can be archieved later.
        staff:
          readOnly: true
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/StaffPermission'
              - description: 'Entries of the staff members of the register.'
        attendees:
          readOnly: true
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/IndividualEntry'
              - description: 'Entries of the attendees of the register.'
        auditDetails:
          $ref: 'https://raw.githubusercontent.com/egovernments/DIGIT-OSS/master/core-services/docs/common-contract.yml#/components/schemas/AuditDetails'
        additionalDetails:
          type: object
          description: Any additional details of the register
      required:
        - tenantId
        - name

    AttendanceRegisterResponse:
      type: object
      properties:
        responseInfo:
          $ref: 'https://raw.githubusercontent.com/egovernments/DIGIT-OSS/subhashini_devguide_changes/core-services/docs/common-contract.yml#/definitions/ResponseInfo'
        attendanceRegister:
          type: array
          items:
            $ref: '#/components/schemas/AttendanceRegister'

    MusterRollRequest:
      type: object
      properties:
        requestInfo:
          $ref: 'https://raw.githubusercontent.com/egovernments/DIGIT-OSS/master/core-services/docs/common-contract.yml#/components/schemas/RequestHeader'
        musterRoll:
          $ref: '#/components/schemas/MusterRoll'
        workflow:
          type: object
          properties:
            action:
              type: string
              description: 'Action of the workflow to be performned on the request'
            comment:
              type: string
              description: 'comment for the workflow action to be performed'
            assignees:
              type: array
              items:
                type: string
                description: ' uuid of the users in the system to assign workflow to the specific user intead of a all the users with the gien role.'
          required:
            - action

    MusterRollResponse:
      type: object
      properties:
        responseInfo:
          $ref: 'https://raw.githubusercontent.com/egovernments/DIGIT-OSS/master/core-services/docs/common-contract.yml#/components/schemas/ResponseHeader'
        musterRolls:
          type: array
          items:
            $ref: '#/components/schemas/MusterRoll'

    RequestInfoWrapper:
      type: object
      properties:
        requestInfo:
          $ref: 'https://raw.githubusercontent.com/egovernments/DIGIT-OSS/master/core-services/docs/common-contract.yml#/components/schemas/RequestHeader'
